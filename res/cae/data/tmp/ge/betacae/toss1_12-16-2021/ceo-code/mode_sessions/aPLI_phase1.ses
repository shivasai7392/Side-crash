$
$ For processing the aPLI Leg provided by HUMANETICS:
$    (HUMANETICS_APLI_SBL_B_V1.0_S2_EXTERIOR.k)
$
$------------------------------------------------------------------------------------------------------------------------------------------------------
$-- VARIABLES

$------------------
$-- GENERAL info

$-- Window names
opt var add femur_window "Femur - Load Cells"
opt var add knee_lig "Knee - Ligaments"
opt var add knee_accel "Knee Accelerometer"
opt var add tibia_window "Tibia - Load Cells"
opt var add force_window "Force Zones"
opt var add combined_window1 "COMBINED1"
opt var add combined_window2 "COMBINED2"

$-- Formatting info
opt var add x_label "Time [ms]"
opt var add x_max 0.06
opt var add x_space 0.005
opt var add x_multiplier -3
opt var add font_info "Nimbus Sans [UKWN],20,-1,5,75,0,0,0,0,0"
opt var add picture_size 488x488
opt var add nXwindow "4"

$------------------
$-- Scale Factors
$ mm/s^2 to g conversion (acceleration)
opt var add pXscale "0.000101971621"
opt var add pXnscale "-0.000101971621"
$ Nmm to Nm conversion (moment)
opt var add fXscale "0.001"

$------------------
$-- DECFORC names

$-- KNEE LIGAMENT SPRINGS
opt var add kl1 "D0KNEEAC00PMDS0C"
opt var add kl2 "D0KNEEPC00PMDS0C"
opt var add kl3 "D0KNEEMC00PMDS0C"

$------------------
$-- NODOUT names

$-- KNEE NODES
opt var add n1 "D0KNEE0000PMACYC"
opt var add n2 "D0KNEE0000PMAVXC"

$------------------
$-- SECFORC names

$-- FEMUR SECTIONS
opt var add f1 "D0FEMRUP00PMMOXC"
opt var add f2 "D0FEMRMI00PMMOXC"
opt var add f3 "D0FEMRLO00PMMOXC"

$-- TIBIA SECTIONS
opt var add t1 "D0TIBIUP00PMMOXC"
opt var add t2 "D0TIBIMIUPPMMOXC"
opt var add t3 "D0TIBIMILOPMMOXC"
opt var add t4 "D0TIBILO00PMMOXC"

$------------------
$-- RCFORC names
$opt var add r1 "1000/1002-1004/1006-1007/1010"
$-- UPDATE THE CONTACT IDS ON LINE 375

$-- DETERMINE DIRECTORY AND SET AS p0

//#!python
# PYTHON script
import os
import meta

def main():
	path = os.getcwd()
	meta.utils.MetaCommand ('opt var add p0 '+path+'')
	var2 = path+"/Session_Report"
	if not os.path.exists(var2):
		os.makedirs(var2)
	
if __name__ == '__main__':
	main()

//#!EOF
$------METAPOST ENVIRONMENT SET UP------------------------------------------------------------------
$
$-- BINOUT VARIABLES
opt var add b0 "binout*"
opt var add pA "${PWD}/${b0}"
#
$ Load the binout files
$
xyplot model load uniq_dyna ${pA}
$
$ Binout read settings
$
xyplot options abscissa lsdyna time
xyplot options read filename off
$
$
$ --------FEMUR - LOAD CELLS WINDOW-----------------------------------------------------------------

xyplot create "${femur_window}"
window active "${femur_window}"
xyplot rlayout "${femur_window}" ${nXwindow}

$
$ --------First Sub-Window (x-moment)-------------
xyplot loadtomodel active
xyplot plotactive "${femur_window}" 0
xyplot read lsdyna "${femur_window}" ${pA} secforc-Section ${f1} X_moment_(xm)
xyplot curve function cfc180 "${femur_window}" ${LAST_CURVE_ID}
xyplot curve rfunction scale y "${femur_window}" ${LAST_CURVE_ID} ${fXscale}
xyplot curve set name "${femur_window}" ${LAST_CURVE_ID} "D0FEMRUP00PMMOXC: FEMUR UPPER (Nm)"
xyplot plotdeactive "${femur_window}" 0

$ --------Second Sub-Window (x-moment)------------
xyplot loadtomodel active
xyplot plotactive "${femur_window}" 1
xyplot read lsdyna "${femur_window}" ${pA} secforc-Section ${f2} X_moment_(xm)
xyplot curve function cfc180 "${femur_window}" ${LAST_CURVE_ID}
xyplot curve rfunction scale y "${femur_window}" ${LAST_CURVE_ID} ${fXscale}
xyplot curve set name "${femur_window}" ${LAST_CURVE_ID} "D0FEMRMI00PMMOXC: FEMUR MID (Nm)"
xyplot plotdeactive "${femur_window}" 1

$ --------Third Sub-Window (x-moment)-------------
xyplot loadtomodel active
xyplot plotactive "${femur_window}" 2
xyplot read lsdyna "${femur_window}" ${pA} secforc-Section ${f3} X_moment_(xm)
xyplot curve function cfc180 "${femur_window}" ${LAST_CURVE_ID}
xyplot curve rfunction scale y "${femur_window}" ${LAST_CURVE_ID} ${fXscale}
xyplot curve set name "${femur_window}" ${LAST_CURVE_ID} "D0FEMRLO00PMMOXC: FEMUR LOWER (Nm)"
xyplot plotdeactive "${femur_window}" 2

$
$-- Window Formatting
xyplot curve visible not "${femur_window}" 1,3,5
xyplot curve set color "${femur_window}" 1-6 "Blue"
xyplot curve set linewidth "${femur_window}" 1-6 "3"

opt var add formatting_window_name "${femur_window}"
opt var add window_number 0
opt var add title_label "Femur - Moment (Upper)"
opt var add y_label "Moment (Nm)"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add window_number 1
opt var add title_label "Femur - Moment (Middle)"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add window_number 2
opt var add title_label "Femur - Moment (Lower)"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

$-- SAVING OUT CSV FILES
xyplot plotactive "${formatting_window_name}" 0-2
xyplot options save multi on
xyplot options save specialformat column
xyplot output file "${formatting_window_name}" "${p0}/Session_Report/FEMUR_MOMENT.csv" 2,4,6
xyplot plotdeactive "${formatting_window_name}" all

$ --------KNEE - LIGAMENTS WINDOW-------------------------------------------------------------------
$
xyplot create "${knee_lig}"
window active "${knee_lig}"
xyplot rlayout "${knee_lig}" ${nXwindow}
$ 
$ --------First Sub-Window (x-moment)-------------
$
xyplot loadtomodel active
xyplot plotactive "${knee_lig}" 0
xyplot read lsdyna "${knee_lig}" ${pA} deforc-SpringDamper ${kl1} Relative_displacement/rotation_(dis)
xyplot curve function cfc180 "${knee_lig}" ${LAST_CURVE_ID}
xyplot curve set name "${knee_lig}" ${LAST_CURVE_ID} "D0KNEEAC00PMDS0C: ACL (mm)"
xyplot plotdeactive "${knee_lig}" 0

$ --------Second Sub-Window (x-moment)------------
xyplot loadtomodel active
xyplot plotactive "${knee_lig}" 1
xyplot read lsdyna "${knee_lig}" ${pA} deforc-SpringDamper ${kl2} Relative_displacement/rotation_(dis)
xyplot curve function cfc180 "${knee_lig}" ${LAST_CURVE_ID}
xyplot curve set name "${knee_lig}" ${LAST_CURVE_ID} "D0KNEEPC00PMDS0C: PCL (mm)"
xyplot plotdeactive "${knee_lig}" 1

$ --------Third Sub-Window (x-moment)-------------
xyplot loadtomodel active
xyplot plotactive "${knee_lig}" 2
xyplot read lsdyna "${knee_lig}" ${pA} deforc-SpringDamper ${kl3} Relative_displacement/rotation_(dis)
xyplot curve function cfc180 "${knee_lig}" ${LAST_CURVE_ID}
xyplot curve set name "${knee_lig}" ${LAST_CURVE_ID} "D0KNEEMC00PMDS0C: MCL (mm)"
xyplot plotdeactive "${knee_lig}" 2

$
$-- Window Formatting
$
xyplot curve visible not "${knee_lig}" 1,3,5
xyplot curve set color "${knee_lig}" 1-6 "Blue"
xyplot curve set linewidth "${knee_lig}" 1-6 "3"

opt var add formatting_window_name "${knee_lig}"
opt var add window_number 0
opt var add title_label "ACL - Elongation"
opt var add y_label "Elongation (mm)"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add window_number 1
opt var add title_label "PCL - Elongation"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add window_number 2
opt var add title_label "MCL - Elongation"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

$-- SAVING OUT CSV FILES
xyplot plotactive "${formatting_window_name}" 0-2
xyplot options save multi on
xyplot options save specialformat column
xyplot output file "${formatting_window_name}" "${p0}/Session_Report/KNEE_ELONGATION.csv" 2,4,6
xyplot plotdeactive "${formatting_window_name}" all


$ --------KNEE ACCELEROMETER + ARS WINDOW-----------------------------------------------------------

xyplot create "${knee_accel}"
window active "${knee_accel}"
xyplot rlayout "${knee_accel}" ${nXwindow}

$
$ --------First Sub-Window (y-acceleration)-------
xyplot loadtomodel active
xyplot plotactive "${knee_accel}" 0
xyplot read lsdyna "${knee_accel}" ${pA} nodout-Node ${n1} Y_acceleration_(ya)
xyplot curve function cfc180 "${knee_accel}" ${LAST_CURVE_ID}
xyplot curve rfunction scale y "${knee_accel}" ${LAST_CURVE_ID} ${pXnscale}
xyplot curve set name "${knee_accel}" ${LAST_CURVE_ID} "D0KNEE0000PMACYC - Knee Accel (g)"
xyplot plotdeactive "${knee_accel}" 0

$ --------Second Sub-Window (y-displacement)------
xyplot loadtomodel active
xyplot plotactive "${knee_accel}" 1
xyplot read lsdyna "${knee_accel}" ${pA} nodout-Node ${n2} Y_displacement_(yd)
xyplot curve function cfc180 "${knee_accel}" ${LAST_CURVE_ID}
xyplot curve set name "${knee_accel}" ${LAST_CURVE_ID} "D0KNEE0000PMACYC - Knee Stroke (mm)"

xyplot loadtomodel active
xyplot plotactive "${knee_accel}" 2
xyplot curve function userdef "${knee_accel}" "c4.y" "c2.y" "Knee Accelerometer"
xyplot curve set name "${knee_accel}" ${LAST_CURVE_ID} "D0KNEE0000PMACYC - Knee Accel (g)"

$
$-- Window Formatting
$
xyplot curve visible not "${knee_accel}" 1,3,5
xyplot curve set color "${knee_accel}" 1-4,6 "Blue"
xyplot curve set linewidth "${knee_accel}" 1-4,6"3"

opt var add formatting_window_name "${knee_accel}"
opt var add window_number 0
opt var add title_label "Knee - Acceleration Y (Global X)"
opt var add y_label "Acceleration (g)"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add window_number 1
opt var add title_label "Knee - Displacement Y (Global X)"
opt var add y_label "Stroke (mm)"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add window_number 2
opt var add title_label "Knee - Accel Y over Disp Y"
opt var add y_label "Acceleration (g)"
opt var add x_label "Stroke (mm)"
opt var add x_max 100
opt var add x_space 10
opt var add x_multiplier 0

read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add x_label "Time [ms]"
opt var add x_max 0.06
opt var add x_space 0.005
opt var add x_multiplier -3

$-- SAVING OUT CSV FILES
xyplot plotactive "${formatting_window_name}" 0-1
xyplot options save multi on
xyplot options save specialformat column
xyplot output file "${formatting_window_name}" "${p0}/Session_Report/KNEE_ACCEL.csv" 2,4
xyplot plotdeactive "${formatting_window_name}" all

$ --------TIBIA - LOAD CELLS WINDOW-----------------------------------------------------------------

xyplot create "${tibia_window}"
window active "${tibia_window}"
xyplot rlayout "${tibia_window}" ${nXwindow}

$ --------First Sub-Window (x-moment)-------------
xyplot loadtomodel active
xyplot plotactive "${tibia_window}" 0
xyplot read lsdyna "${tibia_window}" ${pA} secforc-Section ${t1} X_moment_(xm)
xyplot curve function cfc180 "${tibia_window}" ${LAST_CURVE_ID}
xyplot curve rfunction scale y "${tibia_window}" ${LAST_CURVE_ID} ${fXscale}
xyplot curve set name "${tibia_window}" ${LAST_CURVE_ID} "D0TIBIUP00PMMOXC: Tibia Upper (Nm)"
xyplot plotdeactive "${tibia_window}" 0

$ --------Second Sub-Window (x-moment)------------
xyplot loadtomodel active
xyplot plotactive "${tibia_window}" 1
xyplot read lsdyna "${tibia_window}" ${pA} secforc-Section ${t2} X_moment_(xm)
xyplot curve function cfc180 "${tibia_window}" ${LAST_CURVE_ID}
xyplot curve rfunction scale y "${tibia_window}" ${LAST_CURVE_ID} ${fXscale}
xyplot curve set name "${tibia_window}" ${LAST_CURVE_ID} "D0TIBIMIUPPMMOXC: Tibia Mid Upper (Nm)"
xyplot plotdeactive "${tibia_window}" 1

$ --------Third Sub-Window (x-moment)-------------
xyplot loadtomodel active
xyplot plotactive "${tibia_window}" 2
xyplot read lsdyna "${tibia_window}" ${pA} secforc-Section ${t3} X_moment_(xm)
xyplot curve function cfc180 "${tibia_window}" ${LAST_CURVE_ID}
xyplot curve rfunction scale y "${tibia_window}" ${LAST_CURVE_ID} ${fXscale}
xyplot curve set name "${tibia_window}" ${LAST_CURVE_ID} "D0TIBIMILOPMMOXC: Tibia Mid Lower (Nm)"
xyplot plotdeactive "${tibia_window}" 2

$ --------Fourth Sub-Window (x-moment)------------
xyplot loadtomodel active
xyplot plotactive "${tibia_window}" 3
xyplot read lsdyna "${tibia_window}" ${pA} secforc-Section ${t4} X_moment_(xm)
xyplot curve function cfc180 "${tibia_window}" ${LAST_CURVE_ID}
xyplot curve rfunction scale y "${tibia_window}" ${LAST_CURVE_ID} ${fXscale}
xyplot curve set name "${tibia_window}" ${LAST_CURVE_ID} "D0TIBILO00PMMOXC: Tibia Lower (Nm)"
xyplot plotdeactive "${tibia_window}" 3

$
$-- Window Formatting
$
xyplot curve visible not "${tibia_window}" 1,3,5,7
xyplot curve set color "${tibia_window}" 1-8 "Blue"
xyplot curve set linewidth "${tibia_window}" 1-8 "3"

opt var add formatting_window_name "${tibia_window}"
opt var add window_number 0
opt var add title_label "Tibia - Moment Upper"
opt var add y_label "Moment (Nm)"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add window_number 1
opt var add title_label "Tibia - Moment Mid/Upper"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add window_number 2
opt var add title_label "Tibia - Moment Mid/Lower"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

opt var add window_number 3
opt var add title_label "Tibia - Moment Lower"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

$-- SAVING OUT CSV FILES
xyplot plotactive "${formatting_window_name}" 0-1
xyplot options save multi on
xyplot options save specialformat column
xyplot output file "${formatting_window_name}" "${p0}/Session_Report/TIBIA_MOMENT.csv" 2,4,6,8
xyplot plotdeactive "${formatting_window_name}" all

$ --------FORCE ZONES WINDOW-----------------------------------------------------------------

xyplot create "${force_window}"
window active "${force_window}"

xyplot loadtomodel active
xyplot plotactive "${force_window}" 0
xyplot read lsdyna "${force_window}" "${pA}" rcforc-Master 1000-1011 Magnitude_of_force_(mf)
xyplot plotdeactive "${force_window}" 0
xyplot curve set name "${force_window}" "1" "Hood"
xyplot curve set name "${force_window}" "2" "Headlight"
xyplot curve set name "${force_window}" "3" "Grille Upper"
xyplot curve set name "${force_window}" "4" "Grille Lower"
xyplot curve set name "${force_window}" "5" "Fascia Upper"
xyplot curve set name "${force_window}" "6" "Fascia Mid"
xyplot curve set name "${force_window}" "7" "Fascia Bumper Local"
xyplot curve set name "${force_window}" "8" "Fascia Lower"
xyplot curve set name "${force_window}" "9" "Foglight Lens"
xyplot curve set name "${force_window}" "10" "Skid Garnish"
xyplot curve set name "${force_window}" "11" "A-Mark"

xyplot curve set linewidth "${force_window}" all "3"

opt var add formatting_window_name "${force_window}"
opt var add window_number 0
opt var add title_label "Fascia force zones"
opt var add y_label "Force (N)"
read session /cae/data/reference/fr2/_DevelopmentCAE/04_Scripts/phase1_sessions/function_sessions/src/2d_plot_formatting.ses

xyplot plotactive "${formatting_window_name}" 0
xyplot options save multi on
xyplot options save specialformat column
xyplot output file "${formatting_window_name}" "${p0}/Session_Report/FORCE_ZONES.csv" all
xyplot plotdeactive "${formatting_window_name}" all

$ --------COMBINED1 CSV---------------------------------------------------------
xyplot create "${combined_window1}"


$-- KNEE LIGAMENTS
 opt var add formatting_window_name "${knee_lig}"
window active "${formatting_window_name}"
xyplot plotactive "${formatting_window_name}" all
xyplot curve copy "${formatting_window_name}" 0 2,4,6

window active "${combined_window1}"
xyplot plotactive "${combined_window1}" 0
xyplot curve paste "${combined_window1}" 0 2,4,6

xyplot plotactive none none

$-- KNEE ACCEL
 opt var add formatting_window_name "${knee_accel}"
window active "${formatting_window_name}"
xyplot plotactive "${formatting_window_name}" all
xyplot curve copy "${formatting_window_name}" 0 2,4

window active "${combined_window1}"
xyplot plotactive "${combined_window1}" 0
xyplot curve paste "${combined_window1}" 0 2,4

xyplot plotactive none none


$-- FORCE ZONES
 opt var add formatting_window_name "${force_window}"
window active "${formatting_window_name}"
xyplot plotactive "${formatting_window_name}" all
xyplot curve copy "${formatting_window_name}" all

window active "${combined_window1}"
xyplot plotactive "${combined_window1}" 0
xyplot curve paste "${combined_window1}" 0 all

xyplot plotactive none none


$-- OUTPUT

xyplot output file "${combined_window1}" "${p0}/Session_Report/COMBINED1.csv" all

window delete "${combined_window1}"

$ --------COMBINED2 CSV---------------------------------------------------------
xyplot create "${combined_window2}"


$-- FEMUR LOAD CELLS
 opt var add formatting_window_name "${femur_window}"
window active "${formatting_window_name}"
xyplot plotactive "${formatting_window_name}" all
xyplot curve copy "${formatting_window_name}" 2,4,6

window active "${combined_window2}"
xyplot plotactive "${combined_window2}" 0
xyplot curve paste "${combined_window2}" 0 2,4,6

xyplot plotactive none none


$-- TIBIA LOAD CELLS
 opt var add formatting_window_name "${tibia_window}"
window active "${formatting_window_name}"
xyplot plotactive "${formatting_window_name}" all
xyplot curve copy "${formatting_window_name}" 0 2,4,6,8

window active "${combined_window2}"
xyplot plotactive "${combined_window2}" 0
xyplot curve paste "${combined_window2}" 0 2,4,6,8

xyplot plotactive none none


$-- OUTPUT

xyplot output file "${combined_window2}" "${p0}/Session_Report/COMBINED2.csv" all

window delete "${combined_window2}"
$------------------------------------------------------------------------------------------------------------------------------------------------------
$-- SAVE PLOT PROJECT FILE

options session controldraw enable

write options Project references 2dplot enable
write options Project typesave 2d
write options Project pagesave all
write project "label" "${p0}/Session_Report/apli_summary.metadb"

$-- END